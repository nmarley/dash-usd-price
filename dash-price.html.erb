<!DOCTYPE html>
<html id="htmlTop" lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title data-bind="text: page_title"></title>
  <link rel="stylesheet" href="css/main.css">
</head>
<body>

  <div>
    Bitstamp BTC/USD Price: <span id="btc_usd_price" data-bind="text: formattedPrice"><%= btc_usd %></span><br>
    latest update: <span id="bits_ts" data-bind="text: bitsTs"><%= bits_ts %></span>
  </div>

  <hr>

  <div>
    Poloniex BTC/Dash Price: <span id="polo_btc_dash" data-bind="text: polo_btc_dash"><%= dash_btc %></span><br>
    latest update: <span id="polo_ts" data-bind="text: polo_btc_dash_ts"><%= polo_ts %></span>
  </div>

  <hr>

  <div>
    $<span data-bind="text: formattedPrice"><%= btc_usd %></span> * <span data-bind="text: polo_btc_dash"><%= dash_btc %></span> = $<span data-bind="text: dash_usd"><%= dash_usd %></span> USD / Dash<br>
    <small>Value last updated: <span id="lastDashUSDUpdate" data-bind="text: lastDashUSDUpdate"><%= last_page_gen %></span></small>
  </div>

<!-- LTC price... who cares? -->
<!--
  <hr>

  <div>
    Poloniex BTC/LTC Price: <%= btc_ltc %><br>
    latest update: <%= polo_ts %>
  </div>
  -->

</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.0/jquery.min.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.4.0/knockout-min.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.11.1/moment.min.js" type="text/javascript"></script>
<script src="http://js.pusher.com/2.2/pusher.min.js" type="text/javascript"></script>
<script src="https://autobahn.s3.amazonaws.com/autobahnjs/latest/autobahn.min.jgz" type="text/javascript"></script>

<script type="text/javascript">
var getNow = function () {
  var formattedDate = moment().utc().format('YYYY-MM-DD HH:mm:ss UTC');
  return formattedDate;
}

function BitstampViewModel() {
  var self = this;

  var current_val = parseFloat(jQuery('#btc_usd_price').text());
  var current_bits_ts = jQuery('#bits_ts').text();
  var current_polo_btc_dash = jQuery('#polo_btc_dash').text();
  var current_polo_ts = jQuery('#polo_ts').text();
  var last_update = jQuery('#lastDashUSDUpdate').text();

  self.price = ko.observable(current_val);
  self.bitsTs = ko.observable(current_bits_ts);
  self.polo_btc_dash = ko.observable(current_polo_btc_dash);
  self.polo_btc_dash_ts = ko.observable(current_polo_ts);
  self.lastDashUSDUpdate = ko.observable(last_update);

  self.newPrice = function(price) {
    var now = getNow();

    self.price(price);
    self.bitsTs(now);
    self.lastDashUSDUpdate(now);
  };

  self.newPolo = function(polo_btc_dash) {
    var now = getNow();

    self.polo_btc_dash(polo_btc_dash);
    self.polo_btc_dash_ts(now);
    self.lastDashUSDUpdate(now);
  }

  self.dash_usd = ko.computed(function() {
    return (self.price() * self.polo_btc_dash()).toFixed(2);
  })

  self.page_title = ko.computed(function() {
    return self.dash_usd() + " = Dash/USD Rate";
  })

  self.formattedPrice = ko.computed(function() {
      return self.price().toFixed(2);
  });
}

$(document).ready(function() {
  var pusher = new Pusher('de504dc5763aeef9ff52');
  var channel = pusher.subscribe('live_trades');
  channel.bind('trade', function(data) {
    console.log('Bitstamp: ' + 'id:' + data.id + ' price: ' + data.price + ' amount: ' + data.amount);
    viewModel.newPrice(data.price);
  });

  var poloniex_ticker_labels = ["currencyPair", "last", "lowestAsk", "highestBid", "percentChange", "baseVolume", "quoteVolume", "isFrozen", "24hrHigh", "24hrLow"];
  poloniex_conn.onopen = function (session) {
    function tickerEvent (args, kwargs) {
      var h = poloniex_ticker_labels.reduce(function(prev, curr, index, arr) {
        prev[arr[index]] = args[index];
        return prev;
      }, {});
      if (h.currencyPair === "BTC_DASH") {
        console.log("Poloniex: BTC_DASH = " + h.last);
        viewModel.newPolo(h.last);
      }
    }
    session.subscribe('ticker', tickerEvent);
  }

  ko.applyBindings(viewModel, document.getElementById('htmlTop'));
});
var viewModel = new BitstampViewModel();
var poloniex_conn = new autobahn.Connection({
  url: "wss://api.poloniex.com",
  realm: "realm1"
});
poloniex_conn.open();
</script>
</html>
